<?xml version="1.0" encoding="UTF-8" ?>
<!-- 
Copyright (c) 2010 Cloudsmith Inc, Martin Taal (Doorn, The Netherlands) and others.
All rights reserved. This program and the accompanying materials
are made available under the terms of the Eclipse Public License v1.0
which accompanies this distribution, and is available at
http://www.eclipse.org/legal/epl-v10.html

Contributors:
  Cloudsmith Inc - build.xml for Buckminster project
   Martin Taal - changes for Teneo

Some important parts have been copied from Buckminster's own
build setup:
http://dev.eclipse.org/viewsvn/index.cgi/trunk/org.eclipse.buckminster.releng/build.xml?root=Tools_BUCKMINSTER&view=markup
-->
<project default="run" name="Texo Builds">
	<!-- load properties and set timestamp for the build -->
	<property environment="env"/>

	
	<tstamp>
		<format property="buildTimestamp" pattern="yyyyMMddHHmm" />
	</tstamp>

	<condition property="buildsPath" value="${env.WORKSPACE}" else="${basedir}/../builds">
		<isset property="env.WORKSPACE" />
	</condition>

	<condition property="debug.mode" value="${env.DEBUG}" else="true">
		<isset property="env.DEBUG" />
	</condition>
	
	<!-- Is used in buck.minster also -->
	<condition property="build.type" value="${env.BUILDTYPE}" else="N">
		<isset property="env.BUILDTYPE" />
	</condition>
	
	<property name="rootPath" location="${buildsPath}/${build.type}${buildTimestamp}"/>
		
	<property name="buildRoot" location="${rootPath}/build"/>
	<property name="testRoot" location="${rootPath}/test"/>	
	<property name="toolsPath" location="${rootPath}/tools"/>		
	<property name="buildSitePath" location="${rootPath}/result/p2site"/>
	<property name="buildZipsPath" location="${rootPath}/result/zips"/>
	<property name="testResultsPath" location="${rootPath}/result/test"/>

	<property name="buckminster.output.root" location="${rootPath}/output" />
	<property name="buckminster.output.temp" location="${rootPath}/temp" />

	<target name="run" depends="init">
   	    <echo message="Building" />
	    <ant dir="${basedir}/build" antfile="teneo_build.xml" target="run" inheritRefs="true"/>

		<echo message="Testing" />
	    <ant dir="${basedir}/test" antfile="teneo_test.xml" target="run" inheritRefs="true"/>

		<echo message="Cleaning up" />
	    <antcall target="cleanUp" inheritAll="true"/>
	</target>

	<target name="init">
		<echo message="Creating main directories"/>
		<echo message="rootPath: ${rootPath}"/>
		<echo message="buildRoot: ${buildRoot}"/>
		<echo message="testRoot: ${testRoot}"/>
		<echo message="buildSitePath: ${buildSitePath}"/>
		<echo message="buildZipsPath: ${buildZipsPath}"/>
		<echo message="testResultsPath: ${testResultsPath}"/>
		<mkdir dir="${rootPath}"/>
		<mkdir dir="${buildRoot}"/>
		<mkdir dir="${testRoot}"/>
		<mkdir dir="${toolsPath}"/>
		<mkdir dir="${buildSitePath}"/>
		<mkdir dir="${buildZipsPath}"/>
		<mkdir dir="${testResultsPath}"/>

		<echo message="Unzipping buckminster to ${toolsPath}"/>
		<unzip src="buckminster3.6.zip" dest="${toolsPath}" />
	</target>

	<target name="cleanUp" depends="doConditionalCleanup">
	</target>

	<target name="determine.do.cleanup">
    		<condition property="do.cleanup">
			<not>
				<equals arg1="${debug.mode}" arg2="true"/>
			</not>
    		</condition>
	</target>

	<target name="doConditionalCleanup" depends="determine.do.cleanup" if="do.cleanup">
		<delete dir="${toolsPath}" failonerror="true" quiet="true" />
		<delete dir="${buildRoot}" failonerror="true" quiet="true" />
		<delete dir="${testRoot}" failonerror="true" quiet="true" />
		<delete dir="${buckminster.output.temp}" failonerror="true" quiet="true" />
		<delete dir="${buckminster.output.root}" failonerror="true" quiet="true" />
	</target>
</project>
